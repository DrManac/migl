<html>
<head>
	<title>MPR View</title>
	<meta charset="utf-8"></meta>
	<style>
body {
	color: #ffffff;
	font-family:Monospace;
	font-size:13px;
	text-align:center;
	font-weight: bold;

	background-color: #AAAAAA;
	margin: 0px;
}

#root {
	position: absolute;
	left:0px;
	right:0px;
	top:0px;
	bottom: 0px;
	display: flex;
	flex-direction: column;
}

#workarea {
	position: relative;
	display: flex;
	flex: 1 1 auto;
}
	</style>
</head>
<body>
<div id="root">
	<div id="toolstrip">
		<label><input type="radio" name="tool" value="cross">Cross</label>
		<label><input type="radio" name="tool" value="pan">Pan</label>
		<label><input type="radio" name="tool" value="zoom">Zoom</label>
		<label><input type="radio" name="tool" value="rotate">Rotate</label>
		<label><input type="radio" name="tool" value="window">Window</label>
		<label><input type="checkbox" id="invertcb">Invert</label>
	</div>
	<div id="workarea"></div>
</div>
<script src="../build/migl.js"></script>
<script>


var workarea = new migl.ViewArea(document.getElementById('workarea'));

var view1 = new migl.SliceView();
var view2 = new migl.SliceView();
var view3 = new migl.SliceView();
var cview = new migl.CompositeView(view1, view2, view3);

workarea.SetLayout([{element: view1}, {element: view2}, {element: view3}]);

var xort = [1, 0, 0];
var yort = [0, 1, 0];
var zort = [0, 0, -1];

view1.SetOrts(xort, yort);
view2.SetOrts(xort, zort);
view3.SetOrts(yort, zort);

var cmp = new migl.Compass();
cview.Add2dSceneElement(cmp);

var tools = {
	cross: new migl.tools.Cross(),
	pan: new migl.tools.Pan(),
	rotate: new migl.tools.Rotate(),
	window: new migl.tools.Window(),
};

var btns = document.getElementById('toolstrip').getElementsByTagName('input');
for(let btn of btns)
	btn.addEventListener('click', selectTool);
document.getElementById('invertcb').addEventListener('click', invert);

function selectTool(e) {
	var tool = tools[e.currentTarget.value];
	if(tool)
		cview.activetool = tool;
}

function invert(e) {
	cview.invert = e.currentTarget.checked;
}

migl.DragNDrop.enable(document.getElementById('workarea'), processFiles);

// var vi = new migl.VolumeInfo({width: 128, height: 128, depth: 128, pixelHeight: 1, pixelDepth: 1, pixelRepresentation: 1});
//
// let delay = (time) => (result) => new Promise(resolve => setTimeout(() => resolve(result), time));
//
// var data = [];
// for(var z = 0; z < vi.depth; z++) {
// 	var slice = new Uint8Array(vi.width * vi.height);
// 	for (var y = 0; y < vi.height; y++) {
// 		for (var x = 0; x < vi.width; x++) {
// 			var pt = [(x - vi.width / 2) * vi.pixelWidth, (y - vi.height / 2) * vi.pixelHeight, (z - vi.depth / 2) * vi.pixelDepth];
// 			var rr = pt[0] * pt[0] + pt[1] * pt[1] + pt[2] * pt[2];
// 			if( rr < 4096 && rr > 1000)
// 				slice[y * vi.width + x] = (x^y^z);
// 		}
// 	}
// 	data.push(Promise.resolve(slice).then(delay(z * 10)));
// 	//data.push(slice);
// }
//
// var vol = new migl.Volume(vi, data);

// view1.SetVolume(vol);
// view2.SetVolume(vol);
// view3.SetVolume(vol);

migl.Dicom.GetStudiesFromWado('/dicom-web/studies/1.3.12.2.1107.5.6.1.1234.1110.0.1046585785986187/metadata').then(migl.Dicom.ParseVolumes).then(
	function(vols) {
		if(vols.length > 0) {
			cview.SetVolume(vols[0]);
			cview.setDefaultWindow(vols[0]);
		}
	}
);


render();
function render()
{
	cview.Render();
	requestAnimationFrame(render);
}

function processFiles(files) {
	migl.Dicom.GetStudiesFromFiles(files).then(migl.Dicom.ParseVolumes).then(
		function(vols) {
			if(vols.length > 0) {
				cview.SetVolume(vols[0]);
				cview.setDefaultWindow(vols[0]);
			}
		}
	);
}

	</script>
</body>
</html>
