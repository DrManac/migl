<!DOCTYPE html>
<html>
<head>
	<title>MPR View</title>
	<meta charset="utf-8"></meta>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
	<style>
body {
	color: #ffffff;
/*	font-family:Monospace;
	font-size:13px;
	text-align:center;
	font-weight: bold;*/

	/*background-color: #AAAAAA;*/
	background-color: #000000;
}

#root {
	position: absolute;
	left:0px;
	right:0px;
	top:0px;
	bottom: 0px;
	display: flex;
	flex-direction: column;
}

#workarea {
	position: relative;
	display: flex;
	flex: 1 1 auto;
}
	</style>
</head>
<body>
<div id="root">
	<div id="toolstrip" class="btn-toolbar" data-toggle="buttons">
		<div class="btn-group mr-2">
			<label class="btn btn-dark active"><input type="radio" name="tool" value="cross">
				<span class="fa-stack">
					<i class="fa fa-crosshairs fa-stack-2x"></i>
				</span> Cross</label>
			<label class="btn btn-dark"><input type="radio" name="tool" value="pan">
				<span class="fa-stack">
					<i class="fa fa-hand-paper-o fa-stack-2x"></i>
				</span> Pan</label>
			<label class="btn btn-dark"><input type="radio" name="tool" value="zoom">
				<span class="fa-stack">
					<i class="fa fa-search fa-stack-2x"></i>
				</span> Zoom</label>
			<label class="btn btn-dark"><input type="radio" name="tool" value="rotate">
				<span class="fa-stack">
					<i class="fa fa-refresh fa-stack-2x"></i>
				</span> Rotate</label>
		</div>
		<div class="btn-group">
			<div class="btn-group" role="group">
				<button class="btn btn-dark dropdown-toggle" type="button" id="lutButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<img src="lut/grayscale.png" width="32" height="32" id='lutImg'> LUT
				</button>
				<div class="dropdown-menu" aria-labelledby="lutButton" id="lutMenu">
				</div>
			</div>
			<label class="btn btn-dark"><input type="radio" name="tool" value="window">
				<span class="fa-stack">
					<i class="fa fa-adjust fa-stack-2x"></i>
				</span> Window</label>
			<label class="btn btn-dark" id="invertcb"><input type="checkbox">
				<span class="fa-stack">
					<i class="fa fa-square fa-stack-2x"></i>
					<i class="fa fa-adjust fa-stack-1x text-dark"></i>
				</span> Invert</label>
		</div>
	</div>
	<div id="workarea"></div>
</div>
<script src="../build/migl.js"></script>
<script>

var lang = navigator.languages ? navigator.languages[0] : (navigator.language || navigator.userLanguage);
var dFormat = new Intl.DateTimeFormat(lang, {
	year: "numeric", month: "2-digit", day: "2-digit"
});
var nFormat = new Intl.NumberFormat(lang, {
	maximumFractionDigits: 2
});

var workarea = new migl.ViewArea(document.getElementById('workarea'));

var view1 = new migl.SliceView();
var view2 = new migl.SliceView();
var view3 = new migl.SliceView();
var cview = new migl.CompositeView(view1, view2, view3);

workarea.SetLayout([{element: view1}, {element: view2}, {element: view3}]);

var xort = [1, 0, 0];
var yort = [0, 1, 0];
var zort = [0, 0, -1];

view1.SetOrts(xort, yort);
view2.SetOrts(xort, zort);
view3.SetOrts(yort, zort);

var cmp = new migl.Compass();
cview.Add2dSceneElement(cmp);

var text = new migl.Text({x: 5, y: 5});
view1.Add2dSceneElement(text);

var textll = new migl.Text({x: 5, y: 5, textBaseline: 'bottom'});
textll.text = function() {
	var voi = cview.voi;
	//Pos: ${nFormat.format(tools.cross._point[0])}; ${nFormat.format(tools.cross._point[1])}; ${nFormat.format(tools.cross._point[2])}
	return `WW\\WC: ${(voi.white - voi.black) | 0}\\${((voi.white + voi.black)/2) | 0}`;
};
view1.Add2dSceneElement(textll);

var textur = new migl.Text({x: 5, y: 5, textAlign: 'right'});
view3.Add2dSceneElement(textur);

var tools = {
	cross: new migl.tools.Cross(),
	pan: new migl.tools.Pan(),
	rotate: new migl.tools.Rotate(),
	window: new migl.tools.Window(),
	zoom: new migl.tools.Zoom(),
};

var btns = document.getElementById('toolstrip').getElementsByTagName('label');
for(let btn of btns)
	btn.addEventListener('click', selectTool);
document.getElementById('invertcb').addEventListener('click', invert);

function selectTool(e) {
	var tool = tools[e.currentTarget.firstChild.value];
	if(tool)
		cview.activetool = tool;
}

function invert(e) {
	cview.invert = !cview.invert;
}

//migl.Luts.add("Grayscale", "lut/grayscale.png");
migl.Luts.add("16Step", "lut/16Step.png");
//migl.Luts.add(new Lut("30PercBlack", "lut/30PercBlack.png");
migl.Luts.add("ADACIsocontour", "lut/ADACIsocontour.png");
migl.Luts.add("Auxctq", "lut/Auxctq.png");
migl.Luts.add("BWInvLog", "lut/BWInvLog.png");
migl.Luts.add("BWLog", "lut/BWLog.png");
//migl.Luts.add("BWParabolic", "lut/BWParabolic.png");
//migl.Luts.add("Cyclic", "lut/Cyclic.png");
//migl.Luts.add("Designer", "lut/Designer.png");
migl.Luts.add("ECATRainbow", "lut/ECATRainbow.png");
//Luts.add("Edges", "lut/Edges.png");
migl.Luts.add("Heart", "lut/Heart.png");
migl.Luts.add("Hotbody", "lut/Hotbody.png");
migl.Luts.add("Isocount", "lut/Isocount.png");
migl.Luts.add("Linear", "lut/Linear.png");
migl.Luts.add("MicroDeltaHotMetal", "lut/MicroDeltaHotMetal.png");
migl.Luts.add("PagePhase", "lut/PagePhase.png");
migl.Luts.add("Parathyroid", "lut/Parathyroid.png");
//migl.Luts.add("PETSUVMask", "lut/PETSUVMask.png");
migl.Luts.add("PIXEF", "lut/PIXEF.png");
//migl.Luts.add("QGS10Step", "lut/QGS10Step.png");
//migl.Luts.add("Rainbow", "lut/Rainbow.png");
migl.Luts.add("Red", "lut/Red.png");
migl.Luts.add("Region", "lut/Region.png");
//migl.Luts.add("Siemens PET SUV 50", "lut/Siemens%20PET%20SUV%2050.png");
//migl.Luts.add(Siemens PET SUV 75", "lut/lut/Siemens%20PET%20SUV%2075.png");
migl.Luts.add("Smart1", "lut/Smart1.png");
migl.Luts.add("Spectrum", "lut/Spectrum.png");
migl.Luts.add("Spectrum10Step", "lut/Spectrum10Step.png");
migl.Luts.add("spohaRainbow", "lut/spohaRainbow.png");
migl.Luts.add("Stars", "lut/Stars.png");
migl.Luts.add("Thal", "lut/Thal.png");
//migl.Luts.add("WarmMetal", "lut/WarmMetal.png");
//migl.Luts.add("XT6Cardiac", "lut/XT6Cardiac.png");

var lutMenu = document.getElementById('lutMenu');
for(let lut of [].concat([migl.Luts.default, migl.Luts.defaultOverlay], migl.Luts.list.slice(0, 19))) {
	var el = document.createElement('button');
		/*<button class="dropdown-item" type="button">Action</button>*/
	el.type = 'button';
	el.classList.add('dropdown-item');
	el.innerHTML = `<img src='${lut.url}' width="32" height="16"> ${lut.name}`;
	el.lut = lut;
	el.addEventListener('click', function(e) {
		cview.SetLut(e.currentTarget.lut);
		document.getElementById('lutImg').src = e.currentTarget.lut.url;
	});
	lutMenu.appendChild(el);
}

migl.DragNDrop.enable(document.getElementById('workarea'), processFiles);

// var vi = new migl.VolumeInfo({width: 128, height: 128, depth: 128, pixelHeight: 1, pixelDepth: 1, pixelRepresentation: 1});
//
// let delay = (time) => (result) => new Promise(resolve => setTimeout(() => resolve(result), time));
//
// var data = [];
// for(var z = 0; z < vi.depth; z++) {
// 	var slice = new Uint8Array(vi.width * vi.height);
// 	for (var y = 0; y < vi.height; y++) {
// 		for (var x = 0; x < vi.width; x++) {
// 			var pt = [(x - vi.width / 2) * vi.pixelWidth, (y - vi.height / 2) * vi.pixelHeight, (z - vi.depth / 2) * vi.pixelDepth];
// 			var rr = pt[0] * pt[0] + pt[1] * pt[1] + pt[2] * pt[2];
// 			if( rr < 4096 && rr > 1000)
// 				slice[y * vi.width + x] = (x^y^z);
// 		}
// 	}
// 	data.push(Promise.resolve(slice).then(delay(z * 10)));
// 	//data.push(slice);
// }
//
// var vol = new migl.Volume(vi, data);

// view1.SetVolume(vol);
// view2.SetVolume(vol);
// view3.SetVolume(vol);

//var studiesPromise = migl.Dicom.GetStudiesFromWado('/dicom-web/studies/1.3.6.1.4.1.5962.99.1.1152916310.1104091511.1495801568086.2719.0/metadata');
var studiesPromise = migl.Dicom.GetStudiesFromWado('/dicom-web/studies/1.3.12.2.1107.5.6.1.1234.1110.0.1046585785986187/metadata');

studiesPromise.then(migl.Dicom.ParseVolumes).then(setVolumes);

studiesPromise.then(function(studies) {
	if(studies.length > 0)
		text.text = `${studies[0].patientName}
${studies[0].patientId}
${dFormat.format(studies[0].dateTime)}
${studies[0].description}`;
});


render();
function render()
{
	cview.Render();
	requestAnimationFrame(render);
}

function processFiles(files) {
	migl.Dicom.GetStudiesFromFiles(files).then(migl.Dicom.ParseVolumes).then(setVolumes);
}

function setVolumes(vols) {
	if(vols.length > 0) {
		var vol = vols[0];
		cview.SetVolume(vol);
		cview.setDefaultWindow(vol);
		textur.text = `${vol.width}x${vol.height}x${vol.depth}
${nFormat.format(vol.pixelWidth)}x${nFormat.format(vol.pixelHeight)}x${nFormat.format(vol.pixelDepth)}`;
	}
}

	</script>
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script></body>
</html>
