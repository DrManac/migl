<html>
<head>
	<title>MPR View</title>
	<meta charset="utf-8"></meta>
	<style>
body {
	color: #ffffff;
	font-family:Monospace;
	font-size:13px;
	text-align:center;
	font-weight: bold;

	background-color: #AAAAAA;
	margin: 0px;
}

#workarea
{
	position: absolute;
	left:0px;
	right:0px;
	top:0px;
	bottom: 0px;
	display: flex;
}
	</style>
</head>
<body>
<div id="workarea">
</div>
	<script src="../build/migl.js"></script>
	<script>

var workarea = new migl.ViewArea(document.getElementById('workarea'));

var view1 = new migl.FusionView();
var view2 = new migl.FusionView();
var view3 = new migl.FusionView();

workarea.SetLayout([{element: view1}, {element: view2}, {element: view3}]);

var xort = [1, 0, 0];
var yort = [0, 1, 0];
var zort = [0, 0, -1];

view1.SetOrts(xort, yort, zort);
view2.SetOrts(xort, zort, yort);
view3.SetOrts(yort, zort, xort);

var cmp = new migl.Compass();
view1.Add2dSceneElement(cmp);
view2.Add2dSceneElement(cmp);
view3.Add2dSceneElement(cmp);

migl.DragNDrop.enable(document.getElementById('workarea'), processBuffers);

let delay = (time) => (result) => new Promise(resolve => setTimeout(() => resolve(result), time));

migl.Dicom.GetStudiesFromWado('/dicom-web/studies/1.3.6.1.4.1.5962.99.1.1152916310.1104091511.1495801568086.4.0/metadata').then(migl.Dicom.ParseVolumes).then(
	function(vols) {
		if(vols.length > 0) {
			view1.SetVolume(vols[0]);
			view2.SetVolume(vols[0]);
			view3.SetVolume(vols[0]);
			view1.setDefaultWindow(vols[0]);
			view2.setDefaultWindow(vols[0]);
			view3.setDefaultWindow(vols[0]);
		}
		if(vols.length > 1) {
			view1.SetVolume2(vols[1]);
			view2.SetVolume2(vols[1]);
			view3.SetVolume2(vols[1]);
			view1.setDefaultWindow2(vols[1]);
			view2.setDefaultWindow2(vols[1]);
			view3.setDefaultWindow2(vols[1]);
		}
	}
);


view1.activetool = new migl.Cross();
view2.activetool = new migl.Cross();
view3.activetool = new migl.Cross();

view1.activetool.onPointChanged = opc;
view2.activetool.onPointChanged = opc;
view3.activetool.onPointChanged = opc;

function opc(sender) {
	view1.SetDisplacement(sender._point[0] * zort[0] + sender._point[1] * zort[1] + sender._point[2] * zort[2]);
	view2.SetDisplacement(sender._point[0] * yort[0] + sender._point[1] * yort[1] + sender._point[2] * yort[2]);
	view3.SetDisplacement(sender._point[0] * xort[0] + sender._point[1] * xort[1] + sender._point[2] * xort[2]);
}



// view2.SetDisplacement(0.1);
// view3.SetDisplacement(0.2);

var t = 0;
render();
function render()
{
	t += 0.01;
	// view1.SetDisplacement(Math.sin(t));
	// view2.SetDisplacement(Math.sin(t));
	// view3.SetDisplacement(Math.sin(t));
	view1.Render();
	view2.Render();
	view3.Render();
	requestAnimationFrame(render);
}

function processBuffers(files) {
	migl.Dicom.GetStudiesFromFiles(files).then(migl.Dicom.ParseVolumes).then(
		function(vols) {
			if(vols.length > 0) {
				view1.SetVolume(vols[0]);
				view2.SetVolume(vols[0]);
				view3.SetVolume(vols[0]);
				view1.setDefaultWindow(vols[0]);
				view2.setDefaultWindow(vols[0]);
				view3.setDefaultWindow(vols[0]);
			}
			if(vols.length > 1) {
				view1.SetVolume2(vols[1]);
				view2.SetVolume2(vols[1]);
				view3.SetVolume2(vols[1]);
				view1.setDefaultWindow2(vols[1]);
				view2.setDefaultWindow2(vols[1]);
				view3.setDefaultWindow2(vols[1]);
			}
		}
	);
	//alert(buffers);
}

	</script>
</body>
</html>
